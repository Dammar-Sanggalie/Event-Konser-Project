<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics - Event Konser Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
              },
              secondary: "#4b5563",
              accent: "#ec4899",
            },
            fontFamily: { sans: ["Inter", "system-ui", "sans-serif"] },
          },
        },
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50 font-sans antialiased" data-page="analytics">
    <div class="flex min-h-screen">
      <aside class="w-64 bg-gray-900 text-white flex flex-col flex-shrink-0">
        <div class="p-6 border-b border-gray-800">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-gradient-to-br from-primary-500 to-accent rounded-xl flex items-center justify-center text-xl font-bold"
            >
              âš¡
            </div>
            <div>
              <h1 class="text-lg font-bold">EventKonser</h1>
              <p class="text-xs text-gray-400">Admin Panel</p>
            </div>
          </div>
        </div>

        <nav class="flex-1 p-4 space-y-6 overflow-y-auto">
          <div>
            <p
              class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2"
            >
              Main Menu
            </p>
            <a
              href="/admin-dashboard.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸ“Š</span> Dashboard</a
            >
            <a
              href="/analytics.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary-600 text-white font-medium"
              ><span>ğŸ“ˆ</span> Analytics</a
            >
          </div>
          <div>
            <p
              class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2"
            >
              Event Management
            </p>
            <a
              href="/event-management.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸ“…</span> Events</a
            >
            <a
              href="/schedule-management.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸ•’</span> Schedules</a
            >
            <a
              href="/ticket-management.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸŸï¸</span> Tickets</a
            >
          </div>
          <div>
            <p
              class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2"
            >
              Transactions
            </p>
            <a
              href="/order-management.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸ›’</span> Orders</a
            >
            <a
              href="/payment-management.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸ’³</span> Payments</a
            >
            <a
              href="/promo-management.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸ·ï¸</span> Promos</a
            >
          </div>
          <div>
            <p
              class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2"
            >
              Master Data
            </p>
            <a
              href="/user-management.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸ‘¥</span> Users</a
            >
            <a
              href="/category-management.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸ“‚</span> Categories</a
            >
            <a
              href="/artist-management.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸ¤</span> Artists</a
            >
            <a
              href="/venue-management.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸ“</span> Venues</a
            >
            <a
              href="/sponsor-management.html"
              class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-800 hover:text-white transition"
              ><span>ğŸ¤</span> Sponsors</a
            >
          </div>
        </nav>

        <div class="p-4 border-t border-gray-800">
          <button
            onclick="handleLogout()"
            class="w-full px-4 py-2 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500/20 transition font-medium"
          >
            ğŸšª Logout
          </button>
        </div>
      </aside>

      <div class="flex-1 flex flex-col min-h-screen">
        <header class="bg-white shadow-sm">
          <div class="px-8 py-6">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-2xl font-bold text-gray-900">Analytics</h2>
                <p class="text-gray-600 mt-1">Platform performance overview</p>
              </div>
            </div>
          </div>
        </header>
        <main class="flex-1 p-8">
          <div class="max-w-7xl mx-auto">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
              <div
                class="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-300 p-6 rounded-xl shadow-lg hover:shadow-xl transition"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-green-700 text-sm font-bold uppercase tracking-wide"
                  >
                    Total Revenue
                  </h3>
                  <span
                    class="p-3 bg-green-200 text-green-700 rounded-lg text-xl"
                    >ğŸ’°</span
                  >
                </div>
                <p class="text-3xl font-bold text-green-900" id="total-revenue">
                  Rp 0
                </p>
                <p class="text-xs text-green-700 mt-2 font-semibold">
                  All time earnings
                </p>
              </div>
              <div
                class="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 p-6 rounded-xl shadow-lg hover:shadow-xl transition"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-blue-700 text-sm font-bold uppercase tracking-wide"
                  >
                    Total Orders
                  </h3>
                  <span class="p-3 bg-blue-200 text-blue-700 rounded-lg text-xl"
                    >ğŸ›’</span
                  >
                </div>
                <p class="text-3xl font-bold text-blue-900" id="total-orders">
                  0
                </p>
                <p class="text-xs text-blue-700 mt-2 font-semibold">
                  All time orders
                </p>
              </div>
              <div
                class="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-300 p-6 rounded-xl shadow-lg hover:shadow-xl transition"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-purple-700 text-sm font-bold uppercase tracking-wide"
                  >
                    Total Users
                  </h3>
                  <span
                    class="p-3 bg-purple-200 text-purple-700 rounded-lg text-xl"
                    >ğŸ‘¥</span
                  >
                </div>
                <p class="text-3xl font-bold text-purple-900" id="total-users">
                  0
                </p>
                <p class="text-xs text-purple-700 mt-2 font-semibold">
                  Registered members
                </p>
              </div>
              <div
                class="bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-300 p-6 rounded-xl shadow-lg hover:shadow-xl transition"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-orange-700 text-sm font-bold uppercase tracking-wide"
                  >
                    Total Events
                  </h3>
                  <span
                    class="p-3 bg-orange-200 text-orange-700 rounded-lg text-xl"
                    >ğŸ“…</span
                  >
                </div>
                <p class="text-3xl font-bold text-orange-900" id="total-events">
                  0
                </p>
                <p class="text-xs text-orange-700 mt-2 font-semibold">
                  Active events
                </p>
              </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
              <div
                class="bg-gradient-to-br from-blue-50 to-white border-2 border-blue-200 p-8 rounded-xl shadow-lg"
              >
                <h3
                  class="text-xl font-bold text-blue-900 mb-6 flex items-center"
                >
                  <span class="w-1 h-6 bg-blue-600 rounded-full mr-3"></span>
                  Revenue Trend (Last 6 Months)
                </h3>
                <div class="bg-white p-4 rounded-lg">
                  <canvas id="revenueChart" height="200"></canvas>
                </div>
              </div>
              <div
                class="bg-gradient-to-br from-purple-50 to-white border-2 border-purple-200 p-8 rounded-xl shadow-lg"
              >
                <h3
                  class="text-xl font-bold text-purple-900 mb-6 flex items-center"
                >
                  <span class="w-1 h-6 bg-purple-600 rounded-full mr-3"></span>
                  Orders by Status
                </h3>
                <div class="bg-white p-4 rounded-lg">
                  <canvas id="ordersChart" height="200"></canvas>
                </div>
                <!-- Status Legend dengan deskripsi -->
                <div class="mt-6 grid grid-cols-2 gap-3">
                  <div
                    class="flex items-center gap-2 p-2 bg-green-50 rounded-lg border border-green-200"
                  >
                    <span class="w-3 h-3 bg-green-600 rounded-full"></span>
                    <div>
                      <p class="text-xs font-bold text-green-900">âœ“ Paid</p>
                      <p class="text-xs text-green-700">Pembayaran selesai</p>
                    </div>
                  </div>
                  <div
                    class="flex items-center gap-2 p-2 bg-orange-50 rounded-lg border border-orange-200"
                  >
                    <span class="w-3 h-3 bg-orange-600 rounded-full"></span>
                    <div>
                      <p class="text-xs font-bold text-orange-900">
                        â³ Pending
                      </p>
                      <p class="text-xs text-orange-700">Menunggu pembayaran</p>
                    </div>
                  </div>
                  <div
                    class="flex items-center gap-2 p-2 bg-red-50 rounded-lg border border-red-200"
                  >
                    <span class="w-3 h-3 bg-red-600 rounded-full"></span>
                    <div>
                      <p class="text-xs font-bold text-red-900">âœ• Cancelled</p>
                      <p class="text-xs text-red-700">Pesanan dibatalkan</p>
                    </div>
                  </div>
                  <div
                    class="flex items-center gap-2 p-2 bg-indigo-50 rounded-lg border border-indigo-200"
                  >
                    <span class="w-3 h-3 bg-indigo-600 rounded-full"></span>
                    <div>
                      <p class="text-xs font-bold text-indigo-900">âš  Failed</p>
                      <p class="text-xs text-indigo-700">Pembayaran gagal</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/admin.js"></script>
    <script>
      window.addEventListener("load", async () => {
        if (typeof window.admin !== "undefined")
          window.admin.protectAdminPage();
        await loadAnalytics();
      });
      function handleLogout() {
        if (confirm("Are you sure you want to logout?")) {
          window.auth.removeUser();
          localStorage.removeItem("authToken");
          window.location.href = "/login.html";
        }
      }
      async function loadAnalytics() {
        try {
          console.log("ğŸ”„ Starting loadAnalytics...");
          console.log("ğŸ“ API Base URL:", window.API_BASE_URL);

          // Initialize all UI elements with loading state
          document.getElementById("total-revenue").textContent = "Loading...";
          document.getElementById("total-orders").textContent = "Loading...";
          document.getElementById("total-users").textContent = "Loading...";
          document.getElementById("total-events").textContent = "Loading...";

          // Fetch real data for counts with proper error handling
          let orders = [];
          let users = [];
          let events = [];

          // Fetch orders
          try {
            console.log(
              "ğŸ“¦ Fetching orders from:",
              `${window.API_BASE_URL}/orders`
            );
            const ordersRes = await fetch(`${window.API_BASE_URL}/orders`);

            if (!ordersRes.ok) {
              throw new Error(`Orders API returned status ${ordersRes.status}`);
            }

            const ordersData = await ordersRes.json();
            console.log("âœ… Orders response:", ordersData);

            orders = ordersData && ordersData.data ? ordersData.data : [];
            console.log(`âœ… Found ${orders.length} orders`);
          } catch (error) {
            console.error("âŒ Error fetching orders:", error);
            orders = [];
          }

          // Fetch users
          try {
            console.log(
              "ğŸ‘¥ Fetching users from:",
              `${window.API_BASE_URL}/users`
            );
            const usersRes = await fetch(`${window.API_BASE_URL}/users`);

            if (!usersRes.ok) {
              throw new Error(`Users API returned status ${usersRes.status}`);
            }

            const usersData = await usersRes.json();
            console.log("âœ… Users response:", usersData);

            users = usersData && usersData.data ? usersData.data : [];
            console.log(`âœ… Found ${users.length} users`);
          } catch (error) {
            console.error("âŒ Error fetching users:", error);
            users = [];
          }

          // Fetch events
          try {
            console.log(
              "ğŸ“… Fetching events from:",
              `${window.API_BASE_URL}/events`
            );
            const eventsRes = await fetch(`${window.API_BASE_URL}/events`);

            if (!eventsRes.ok) {
              throw new Error(`Events API returned status ${eventsRes.status}`);
            }

            const eventsData = await eventsRes.json();
            console.log("âœ… Events response:", eventsData);

            events = eventsData && eventsData.data ? eventsData.data : [];
            console.log(`âœ… Found ${events.length} events`);
          } catch (error) {
            console.error("âŒ Error fetching events:", error);
            events = [];
          }

          // Calculate totals
          const totalRevenue = orders
            .filter((o) => o.status === "PAID")
            .reduce((sum, o) => sum + (o.totalHarga || 0), 0);

          console.log("ğŸ’° Total Revenue:", totalRevenue);
          console.log("Analytics Summary:", {
            totalRevenue,
            totalOrders: orders.length,
            totalUsers: users.length,
            totalEvents: events.length,
          });

          // Update UI with actual data
          document.getElementById("total-revenue").textContent =
            formatCurrency(totalRevenue);
          document.getElementById("total-orders").textContent = orders.length;
          document.getElementById("total-users").textContent = users.length;
          document.getElementById("total-events").textContent = events.length;

          console.log("âœ… Analytics data loaded successfully!");

          // Charts
          initCharts(orders);
        } catch (error) {
          console.error("âŒ Critical error loading analytics:", error);
          console.error("Stack trace:", error.stack);
          alert(
            "Error loading analytics data. Please check console for details."
          );

          // Set fallback values
          document.getElementById("total-revenue").textContent = "Error";
          document.getElementById("total-orders").textContent = "Error";
          document.getElementById("total-users").textContent = "Error";
          document.getElementById("total-events").textContent = "Error";
        }
      }

      function initCharts(orders) {
        // Revenue Chart (Mock data for trend, but could be calculated)
        const ctxRev = document.getElementById("revenueChart").getContext("2d");
        new Chart(ctxRev, {
          type: "line",
          data: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
            datasets: [
              {
                label: "Revenue",
                data: [12000000, 19000000, 3000000, 5000000, 2000000, 3000000], // Mock data
                borderColor: "#0ea5e9",
                tension: 0.4,
              },
            ],
          },
          options: { responsive: true },
        });

        // Orders Status Chart (Real data)
        const statusCounts = { PAID: 0, PENDING: 0, CANCELLED: 0, FAILED: 0 };
        orders.forEach((o) => {
          const status = o.status || "PENDING";
          statusCounts[status] = (statusCounts[status] || 0) + 1;
        });

        const ctxOrd = document.getElementById("ordersChart").getContext("2d");
        const totalOrders = orders.length;
        new Chart(ctxOrd, {
          type: "doughnut",
          data: {
            labels: ["âœ“ Paid", "â³ Pending", "âœ• Cancelled", "âš  Failed"],
            datasets: [
              {
                data: Object.values(statusCounts),
                backgroundColor: [
                  "#16a34a", // PAID - Dark Green
                  "#ea580c", // PENDING - Orange
                  "#dc2626", // CANCELLED - Red
                  "#4f46e5", // FAILED - Indigo
                ],
                borderColor: ["#fff", "#fff", "#fff", "#fff"],
                borderWidth: 3,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: {
                  font: { size: 14, weight: "bold" },
                  padding: 20,
                  color: "#374151",
                },
              },
              tooltip: {
                backgroundColor: "#1f2937",
                padding: 12,
                font: { size: 12, weight: "bold" },
                callbacks: {
                  label: function (context) {
                    const value = context.raw;
                    const percentage =
                      totalOrders > 0
                        ? ((value / totalOrders) * 100).toFixed(1)
                        : 0;
                    return `${value} order (${percentage}%)`;
                  },
                  afterLabel: function (context) {
                    const statusLabel = [
                      "Pembayaran Selesai",
                      "Menunggu Pembayaran",
                      "Dibatalkan",
                      "Gagal",
                    ];
                    return statusLabel[context.dataIndex] || "";
                  },
                },
              },
            },
          },
        });
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(amount || 0);
      }
    </script>
  </body>
</html>
