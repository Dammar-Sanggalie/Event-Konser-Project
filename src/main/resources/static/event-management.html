<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Management - Event Konser</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            '50': '#f0f9ff',
                            '100': '#e0f2fe',
                            '200': '#bae6fd',
                            '300': '#7dd3fc',
                            '400': '#38bdf8',
                            '500': '#0ea5e9',
                            '600': '#0284c7',
                            '700': '#0369a1',
                            '800': '#075985',
                            '900': '#0c4a6e'
                        },
                        secondary: '#4b5563',
                        accent: '#ec4899'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="/css/main.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-50 font-sans antialiased" data-page="event-management">
    
    <header id="navbar-placeholder"></header>
    
    <main class="min-h-screen bg-gray-50 pb-16">
        <div class="container mx-auto max-w-6xl px-4 py-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900" id="page-title">Create New Event</h1>
                    <p class="text-gray-600 mt-2">Fill in the details to create an event</p>
                </div>
                <a href="/admin-dashboard.html" class="px-4 py-2 text-primary-600 hover:text-primary-700 font-medium">
                    ‚Üê Back to Dashboard
                </a>
            </div>
            
            <form id="event-form" class="space-y-6">
                <!-- Basic Info Section -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Basic Information</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Event Name *</label>
                            <input type="text" id="namaEvent" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                            <textarea id="deskripsi" rows="4" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none resize-none"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                                <select id="idKategori" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Venue *</label>
                                <select id="idVenue" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                                    <option value="">Select Venue</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Organizer *</label>
                            <input type="text" id="penyelenggara" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                    </div>
                </div>
                
                <!-- Date & Time Section -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Date & Time</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date *</label>
                            <input type="datetime-local" id="tanggalMulai" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">End Date *</label>
                            <input type="datetime-local" id="tanggalSelesai" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                        </div>
                    </div>
                </div>
                
                <!-- Images Section -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Images</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Poster URL</label>
                            <input type="url" id="posterUrl" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none" placeholder="https://...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Banner URL</label>
                            <input type="url" id="bannerUrl" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none" placeholder="https://...">
                        </div>
                    </div>
                </div>
                
                <!-- Status Section -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Status</h2>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Event Status *</label>
                        <select id="status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 outline-none">
                            <option value="UPCOMING">Upcoming</option>
                            <option value="ONGOING">Ongoing</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="CANCELLED">Cancelled</option>
                        </select>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex gap-4">
                    <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-primary-600 to-primary-700 text-white rounded-lg hover:shadow-lg transition font-semibold">
                        <span id="submit-btn-text">Create Event</span>
                    </button>
                    <button type="button" onclick="window.history.back()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-semibold">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </main>
    
    <footer id="footer-placeholder"></footer>
    
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/app.js"></script>
    
    <script>
        let editingEventId = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (!window.auth.isAuthenticated()) {
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                return;
            }
            
            const user = window.auth.getUser();
            if (user.role !== 'ADMIN') {
                window.location.href = '/index.html';
                return;
            }
            
            await loadCategories();
            await loadVenues();
            
            // Check if editing
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');
            
            if (eventId) {
                editingEventId = eventId;
                await loadEventData(eventId);
                document.getElementById('page-title').textContent = 'Edit Event';
                document.getElementById('submit-btn-text').textContent = 'Update Event';
            }
            
            document.getElementById('event-form').addEventListener('submit', handleSubmit);
        });
        
        async function loadCategories() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/categories`);
                const result = await response.json();
                
                if (result.data && result.data.length > 0) {
                    const select = document.getElementById('idKategori');
                    select.innerHTML = '<option value="">Select Category</option>' + 
                        result.data.map(cat => `<option value="${cat.idKategori}">${cat.namaKategori}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        async function loadVenues() {
            try {
                const response = await fetch(`${window.API_BASE_URL}/venues`);
                const result = await response.json();
                
                if (result.data && result.data.length > 0) {
                    const select = document.getElementById('idVenue');
                    select.innerHTML = '<option value="">Select Venue</option>' + 
                        result.data.map(venue => `<option value="${venue.idVenue}">${venue.namaVenue} - ${venue.kota}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading venues:', error);
            }
        }
        
        async function loadEventData(eventId) {
            try {
                const response = await fetch(`${window.API_BASE_URL}/events/${eventId}/details`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const event = result.data;
                    document.getElementById('namaEvent').value = event.namaEvent;
                    document.getElementById('deskripsi').value = event.deskripsi;
                    document.getElementById('idKategori').value = event.idKategori || event.kategori?.idKategori;
                    document.getElementById('idVenue').value = event.idVenue || event.venue?.idVenue;
                    document.getElementById('penyelenggara').value = event.penyelenggara;
                    document.getElementById('posterUrl').value = event.posterUrl || '';
                    document.getElementById('bannerUrl').value = event.bannerUrl || '';
                    document.getElementById('status').value = event.status;
                    
                    // Format dates
                    if (event.tanggalMulai) {
                        document.getElementById('tanggalMulai').value = formatDatetimeLocal(event.tanggalMulai);
                    }
                    if (event.tanggalSelesai) {
                        document.getElementById('tanggalSelesai').value = formatDatetimeLocal(event.tanggalSelesai);
                    }
                }
            } catch (error) {
                console.error('Error loading event:', error);
                showToast('Failed to load event data', 'error');
            }
        }
        
        async function handleSubmit(e) {
            e.preventDefault();
            
            const eventData = {
                namaEvent: document.getElementById('namaEvent').value,
                deskripsi: document.getElementById('deskripsi').value,
                idKategori: parseInt(document.getElementById('idKategori').value),
                idVenue: parseInt(document.getElementById('idVenue').value),
                penyelenggara: document.getElementById('penyelenggara').value,
                posterUrl: document.getElementById('posterUrl').value,
                bannerUrl: document.getElementById('bannerUrl').value,
                status: document.getElementById('status').value,
                tanggalMulai: document.getElementById('tanggalMulai').value,
                tanggalSelesai: document.getElementById('tanggalSelesai').value
            };
            
            try {
                const url = editingEventId 
                    ? `${window.API_BASE_URL}/events/${editingEventId}`
                    : `${window.API_BASE_URL}/events`;
                
                const method = editingEventId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`Event ${editingEventId ? 'updated' : 'created'} successfully`, 'success');
                    setTimeout(() => {
                        window.location.href = '/admin-dashboard.html';
                    }, 1500);
                } else {
                    showToast(result.message || 'Failed to save event', 'error');
                }
            } catch (error) {
                console.error('Error saving event:', error);
                showToast('An error occurred', 'error');
            }
        }
        
        function formatDatetimeLocal(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-6 right-6 px-6 py-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
